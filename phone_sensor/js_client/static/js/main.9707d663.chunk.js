(this["webpackJsonpmachinevision-toolbox-python.phone-sensor"]=this["webpackJsonpmachinevision-toolbox-python.phone-sensor"]||[]).push([[0],{56:function(e,t,n){"use strict";n.r(t);var a=n(2),r=n(0),i=n(15),s=n.n(i),o=n(41),c=n(37),u=n(17),l=n(26),d=n(24),h=n(7),b=n.n(h),f=n(16),m=n(4),v=n(36),j=n(25),w=n(38),p=n.n(w),g=n(39),O=n.n(g),x=n(11),y=n.n(x),k=(n(50),n(27)),S=n(28),C=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;Object(k.a)(this,e),this.state=void 0,this.callbacks=void 0,this.boundSet=void 0,this.state=t,this.callbacks=n?[n]:[],this.boundSet=this.set.bind(this)}return Object(S.a)(e,[{key:"useState",value:function(){var e=this,t=Object(r.useState)(this.state),n=Object(m.a)(t,2),a=n[0],i=n[1];return-1===this.callbacks.indexOf(i)&&this.onChange(i),Object(r.useEffect)((function(){return function(){return e.deRegister(i)}}),[]),[a,this.boundSet]}},{key:"onChange",value:function(e){this.callbacks.push(e)}},{key:"deRegister",value:function(e){this.callbacks.splice(this.callbacks.indexOf(e),1)}},{key:"set",value:function(e){this.state=e;var t,n=Object(u.a)(this.callbacks);try{for(n.s();!(t=n.n()).done;){(0,t.value)(e)}}catch(a){n.e(a)}finally{n.f()}}}]),e}();function D(e){return new Promise((function(t){return setTimeout(t,e)}))}var R=function(){function e(t){var n=this;Object(k.a)(this,e),this.waitingOnButton=void 0,this.sendPhotoFunc=void 0,this.imuRawData=void 0,this.imuDataFrame=void 0,this.lastGrabCmd=void 0,this.latestCmdTimestamps=void 0,this.ws=void 0,this.ws=t,this.waitingOnButton=new C(!1),this.sendPhotoFunc=new C(null),this.imuRawData=new C([[Math.floor(Date.now()/1e3)],[0],[0],[0]]),this.lastGrabCmd=new C({frontFacing:!1,button:!1,wait:null,encoding:"webp",quality:90,resolution:[640,480]}),this.imuDataFrame=new C({unixTimestamp:NaN,error:"No IMU data is available. The device either does not support IMU data or has not been given permission."},(function(e){"error"in e&&delete e.error})),this.latestCmdTimestamps={grab:0,imu:0},t.onmessage=function(){var e=Object(f.a)(b.a.mark((function e(t){var a;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.data,e.abrupt("return",n.onMsg(JSON.parse(a)));case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()}return Object(S.a)(e,[{key:"onMsg",value:function(){var e=Object(f.a)(b.a.mark((function e(t){var n,a,r,i,s=this;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("wait"in t)||null===t.wait){e.next=6;break}if(n=Date.now(),!((a=this.latestCmdTimestamps[t.cmd]+1e3*t.wait-n)>0)){e.next=6;break}return e.next=6,D(a);case 6:e.t0=t.cmd,e.next="grab"===e.t0?9:"imu"===e.t0?12:"disconnect"===e.t0?15:17;break;case 9:return this.lastGrabCmd.set(t),t.button?this.waitingOnButton.set(!0):null!==this.sendPhotoFunc.state?(r=this.sendPhotoFunc.state,this.latestCmdTimestamps.grab=Date.now(),r()):(i=function e(t){s.latestCmdTimestamps.grab=Date.now(),t(),s.sendPhotoFunc.deRegister(e)},this.sendPhotoFunc.onChange(i)),e.abrupt("break",18);case 12:return this.send(this.imuDataFrame.state),this.latestCmdTimestamps.imu=Date.now(),e.abrupt("break",18);case 15:throw this.ws.close(),new Error("Another client device has taken control of websocket");case 17:throw new Error("Unhandled Api message ".concat(t));case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"send",value:function(e){this.ws.send(e instanceof Blob?e:JSON.stringify(e))}}]),e}();R.WS_URL="wss://"+document.domain+":"+window.location.port+"/ws";var E=n(42),F=n(40);n(51);function B(e){var t=e.scope,n=t.data.useState(),i=Object(m.a)(n,1)[0],s=Object(r.useRef)(null),o=Object(r.useRef)();return Object(r.useEffect)((function(){var e=["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],n=s.current;if(o.current)o.current.setData(i);else if(n&&!o.current){var a,r=o.current=new F.a({width:600,height:400,series:[{}].concat(Object(E.a)((null!==(a=t.labels)&&void 0!==a?a:[]).map((function(t,n){return{label:t,stroke:e[n%e.length],points:{show:!1}}})))),axes:[{stroke:"white",labelSize:0,grid:{stroke:"white",width:.1},ticks:{show:!1,size:0},size:0,values:""},{stroke:"white",grid:{stroke:"white",width:.1},ticks:{show:!1}}]},i,n),c=y()(n.parentElement);new ResizeObserver((function(){r.setSize({width:c.offsetWidth,height:c.offsetHeight-25})})).observe(c)}}),[s,i,t.labels]),Object(a.jsx)("div",{ref:s})}function M(e){var t=e.api,n=Object(r.useRef)(null),i=Object(r.useRef)(null),s=t.waitingOnButton.useState(),o=Object(m.a)(s,2),c=o[0],h=o[1],w=Object(r.useState)(!1),g=Object(m.a)(w,2),x=g[0],k=g[1],S=Object(r.useState)(!1),C=Object(m.a)(S,2),D=C[0],R=C[1],E=Object(r.useState)(null),F=Object(m.a)(E,2),M=F[0],T=F[1],z=t.lastGrabCmd.useState(),P=Object(m.a)(z,1)[0],I=P.frontFacing,U=Object(m.a)(P.resolution,2),L=U[0],N=U[1],W=P.quality,H=P.encoding,A=Object(r.useCallback)(Object(f.a)(b.a.mark((function e(){var a,r,s,o,c;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=y()(i.current),r=y()(n.current),h(!1),0!==r.videoHeight){e.next=8;break}return s=r.oncanplay,e.next=7,new Promise((function(e){r.oncanplay=e}));case 7:r.oncanplay=s;case 8:a.width!==r.videoWidth&&(a.width=r.videoWidth),a.height!==r.videoHeight&&(a.height=r.videoHeight),o=y()(a.getContext("2d")),c=Date.now(),o.drawImage(r,0,0),a.toBlob((function(e){t.send(new Blob([new BigUint64Array([BigInt(c)]),y()(e)]))}),"image/".concat(H),W);case 14:case"end":return e.stop()}}),e)}))),[t,h,W,H]);return Object(r.useEffect)((function(){var e=y()(n.current),t={video:{facingMode:(null!==M&&void 0!==M?M:I)?"user":"environment",width:L,height:N}};!function(){var n=Object(f.a)(b.a.mark((function n(){var a;return b.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(null!==e.srcObject){n.next=6;break}return n.next=3,navigator.mediaDevices.getUserMedia(t);case 3:e.srcObject=n.sent,n.next=16;break;case 6:return n.next=8,e.srcObject.getVideoTracks()[0];case 8:if((a=n.sent).getConstraints().facingMode===t.video.facingMode){n.next=15;break}return n.next=12,navigator.mediaDevices.getUserMedia(t);case 12:e.srcObject=n.sent,n.next=16;break;case 15:a.applyConstraints(t.video);case 16:case"end":return n.stop()}}),n)})));return function(){return n.apply(this,arguments)}}()()}),[t,M,I,L,N]),Object(r.useEffect)((function(){!function(){var e=Object(f.a)(b.a.mark((function e(){var n,a,r,i;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,n={accelerometer:Accelerometer,gyroscope:Gyroscope,magnetometer:Magnetometer},a=b.a.mark((function e(){var n,a,s,o;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=Object(m.a)(i[r],2),a=n[0],"function"!=typeof(s=n[1])){e.next=8;break}return e.next=4,navigator.permissions.query({name:a});case 4:(o=new s({frequency:30})).addEventListener("error",(function(e){"NotAllowedError"===e.error.name||("NotReadableError"===e.error.name?console.error("Cannot connect to the sensor."):t.imuDataFrame.set(Object(d.a)(Object(d.a)({},t.imuDataFrame.state),{},Object(l.a)({},a,[o.x,o.y,o.z]))))})),o.addEventListener("reading",(function(){})),o.start();case 8:case"end":return e.stop()}}),e)})),r=0,i=Object.entries(n);case 4:if(!(r<i.length)){e.next=9;break}return e.delegateYield(a(),"t0",6);case 6:r++,e.next=4;break;case 9:e.next=22;break;case 11:if(e.prev=11,e.t1=e.catch(0),"SecurityError"!==e.t1.name){e.next=17;break}console.error("Sensor construction was blocked by a feature policy."),e.next=22;break;case 17:if("ReferenceError"!==e.t1.name){e.next=21;break}console.error("Sensor is not supported by the User Agent."),e.next=22;break;case 21:throw e.t1;case 22:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(){return e.apply(this,arguments)}}()();var e=function(e){var n=e.alpha,a=e.beta,r=e.gamma;if(null!==n){var i=Date.now()/1e3,s=t.imuRawData.state;s[0].push(i/1e3),s[1].push(n),s[2].push(a),s[3].push(r);var o=Object(m.a)(s,1)[0],c=i-5,l=o.findIndex((function(e){return e>=c}));if(l>0){var h,b=Object(u.a)(s);try{for(b.s();!(h=b.n()).done;){h.value.splice(0,l)}}catch(j){b.e(j)}finally{b.f()}}var f=Math.PI/180,v=O.a.fromEuler(y()(n)*f,y()(a)*f,y()(r)*f);t.imuRawData.set(s.slice()),t.imuDataFrame.set(Object(d.a)(Object(d.a)({},t.imuDataFrame.state),{},{unixTimestamp:i,quaternion:[v.x,v.y,v.z,v.w]}))}};return window.addEventListener("deviceorientation",e),function(){return window.removeEventListener("deviceorientation",e)}}),[t.imuRawData,t.imuDataFrame]),Object(a.jsxs)("div",{style:{width:"100vw",height:"100vh",position:"relative",display:"flex"},children:[Object(a.jsx)("video",{ref:n,autoPlay:!0,onCanPlay:function(){t.sendPhotoFunc.set(A)},style:{maxWidth:"100%",maxHeight:"100%",margin:"0 auto"}}),Object(a.jsx)("canvas",{ref:i,style:{display:"none"}}),Object(a.jsxs)("div",{style:{position:"absolute",top:0,display:"flex",flexDirection:"column",justifyContent:"space-between",height:"100vh",width:"100%"},children:[Object(a.jsxs)("div",{style:{display:"flex",justifyContent:"flex-end",alignItems:"start",margin:20},children:[x?Object(a.jsx)("div",{style:{height:100,width:"100%",color:"white",background:"#282c34",borderRadius:5},children:Object(a.jsx)(B,{scope:{name:"Orientation",styles:null,labels:["alpha","beta","gamma"],data:t.imuRawData,keepLastSecs:5}})}):null,Object(a.jsx)(v.a,{variant:"outline-light",style:{borderRadius:99,height:60,width:60,fontSize:32,margin:10},onClick:function(){return R(!0)},children:"\u22ef"}),Object(a.jsxs)(j.a,{show:D,onHide:function(){return R(!1)},size:"lg",children:[Object(a.jsx)(j.a.Header,{closeButton:!0,children:Object(a.jsx)(j.a.Title,{children:"Menu"})}),Object(a.jsxs)(j.a.Body,{children:[Object(a.jsxs)("label",{style:{display:"flex",flexDirection:"row",justifyContent:"space-between",alignItems:"center",fontSize:"1rem"},children:["Show IMU Data?",Object(a.jsx)(p.a,{onChange:k,checked:x,height:30,width:60})]}),Object(a.jsxs)("label",{style:{display:"flex",flexDirection:"row",justifyContent:"space-between",alignItems:"center",fontSize:"1rem"},children:["Camera",Object(a.jsxs)("select",{className:"form-select",onChange:function(e){T({default:null,front:!0,back:!1}[e.target.value])},children:[Object(a.jsx)("option",{value:"default",selected:null===M,children:"Default (obey `phone.grab(cam=?)`)"}),Object(a.jsx)("option",{value:"front",selected:!0===M,children:"Front Camera (touchscreen side)"}),Object(a.jsx)("option",{value:"back",selected:!1===M,children:"Back Camera"})]})]})]})]})]}),c?Object(a.jsx)(v.a,{variant:"outline-light",style:{borderRadius:99,height:90,width:90,fontSize:32,margin:10,marginBottom:50,alignSelf:"center"},disabled:!c,onClick:A,children:"\ud83d\udcf7"}):null]})]})}function T(){var e=function(){var e=Object(r.useState)(null),t=Object(m.a)(e,2),n=t[0],a=t[1];return Object(r.useEffect)((function(){var e=new WebSocket(R.WS_URL);return e.onopen=function(){return a(new R(e))},e.onclose=function(){return a(null)},e.onerror=function(e){return a(new Error("couldn't connect to ws api @ ".concat(R.WS_URL)))},e.close}),[]),n}();if(e instanceof Error)throw e;return e?Object(a.jsx)(M,{api:e}):null}n(55);s.a.render(Object(a.jsx)(o.ErrorBoundary,{fallbackRender:function(e){var t=e.error,n=e.resetErrorBoundary;return Object(a.jsxs)(c.a,{variant:"danger",children:["Something went wrong:",t.toString(),Object(a.jsx)("br",{}),Object(a.jsx)(c.a.Link,{onClick:n,children:"Try again"})]})},children:Object(a.jsx)(T,{})}),document.getElementById("root"))}},[[56,1,2]]]);
//# sourceMappingURL=main.9707d663.chunk.js.map